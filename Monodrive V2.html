<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MonoDrive Ultimate Edition</title>
    <style>
        :root{--bg:#0a0a0a;--fg:#fff;--gold:#ffd700;--silver:#c0c0c0;--bronze:#cd7f32}
        *{box-sizing:border-box;margin:0;padding:0}
        body{background:#000;color:var(--fg);font-family:'Segoe UI',sans-serif;overflow:hidden;touch-action:none;display:flex;justify-content:center;align-items:center;height:100vh}
        #gc{position:relative;width:100%;max-width:500px;height:100%;max-height:900px;background:var(--bg);overflow:hidden;box-shadow:0 0 50px rgba(255,255,255,0.1)}
        canvas{display:block;width:100%;height:100%}
        #ui{position:absolute;top:20px;left:0;width:100%;padding:0 20px;pointer-events:none;display:flex;justify-content:space-between;z-index:5}
        .score-box{text-align:left}
        #scoreVal{font-size:2rem;font-weight:800;display:block;text-shadow:0 0 10px rgba(255,255,255,0.3)}
        .multiplier{font-size:0.8rem;color:#888;letter-spacing:2px}
        #boost-container{width:120px;text-align:right}
        .bar-bg{width:100%;height:6px;background:#222;margin-top:5px;border-radius:3px;overflow:hidden}
        #boost-bar{width:0%;height:100%;background:linear-gradient(90deg,#fff,#aaa);box-shadow:0 0 10px #fff;transition:width 0.1s}
        #xp-container{position:absolute;bottom:20px;left:20px;right:20px;pointer-events:none}
        .xp-label{font-size:0.7rem;color:#888;margin-bottom:3px;display:flex;justify-content:space-between}
        #xp-bar-bg{width:100%;height:8px;background:#222;border-radius:4px;overflow:hidden}
        #xp-bar{width:0%;height:100%;background:linear-gradient(90deg,#4CAF50,#8BC34A);transition:width 0.3s}
        .menu{position:absolute;inset:0;background:rgba(0,0,0,0.95);display:flex;flex-direction:column;justify-content:flex-start;align-items:center;z-index:100;overflow-y:auto;padding:20px}
        h1{font-size:3rem;font-weight:900;margin:20px 0 10px;letter-spacing:-2px;text-shadow:0 0 20px rgba(255,255,255,0.5)}
        .subtitle{color:#666;margin-bottom:20px;font-size:0.9rem;text-transform:uppercase}
        button{background:#fff;border:none;color:#000;padding:15px 35px;font-size:0.9rem;font-weight:800;cursor:pointer;text-transform:uppercase;letter-spacing:2px;transition:0.2s;box-shadow:0 0 20px rgba(255,255,255,0.3);margin:5px;pointer-events:auto}
        button:hover{background:#ccc;transform:translateY(-2px)}
        button.secondary{background:#333;color:#fff}
        .hidden{display:none!important}
        .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;width:100%;max-width:400px;margin:20px 0}
        .stat-card{background:#1a1a1a;padding:15px;border-radius:8px;border:1px solid #333}
        .stat-label{font-size:0.7rem;color:#888;text-transform:uppercase;margin-bottom:5px}
        .stat-value{font-size:1.5rem;font-weight:800}
        .achievement-list,.upgrade-list,.leaderboard-list,.challenge-list{width:100%;max-width:450px;max-height:500px;overflow-y:auto}
        .achievement{background:#1a1a1a;padding:12px;margin:8px 0;border-radius:8px;border-left:4px solid #333;display:flex;align-items:center;gap:12px}
        .achievement.unlocked{border-left-color:var(--gold)}
        .achievement-icon{width:40px;height:40px;background:#333;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
        .achievement.unlocked .achievement-icon{background:var(--gold)}
        .achievement-info{flex:1}
        .achievement-name{font-weight:700;font-size:0.9rem}
        .achievement-desc{font-size:0.7rem;color:#888;margin-top:2px}
        .upgrade-card{background:#1a1a1a;padding:15px;margin:10px 0;border-radius:8px;border:1px solid #333}
        .upgrade-header{display:flex;justify-content:space-between;margin-bottom:10px}
        .upgrade-bar{width:100%;height:6px;background:#333;border-radius:3px;overflow:hidden;margin:10px 0}
        .upgrade-bar-fill{height:100%;background:linear-gradient(90deg,#4CAF50,#8BC34A)}
        .currency{color:var(--gold);font-weight:700}
        .leaderboard-entry{background:#1a1a1a;padding:12px;margin:5px 0;border-radius:8px;display:flex;justify-content:space-between}
        .leaderboard-entry.rank1{border:2px solid var(--gold)}
        .challenge-card{background:#1a1a1a;padding:15px;margin:10px 0;border-radius:8px;border-left:4px solid #4CAF50}
        .challenge-card.completed{border-left-color:var(--gold);opacity:0.7}
        #msg-overlay{position:absolute;top:35%;width:100%;text-align:center;font-weight:900;font-size:1.8rem;pointer-events:none;color:#fff;opacity:0;transform:scale(0.5);transition:0.3s;text-shadow:0 0 20px #fff;z-index:50}
        #msg-overlay.pop{opacity:1;transform:scale(1)}
        #level-up-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.8);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:150;opacity:0;pointer-events:none;transition:0.3s}
        #level-up-overlay.show{opacity:1;pointer-events:auto}
        .level-up-text{font-size:3rem;font-weight:900;color:var(--gold);text-shadow:0 0 30px var(--gold);margin-bottom:20px}
    </style>
</head>
<body>
    <div id="gc">
        <canvas id="gameCanvas"></canvas>
        <div id="ui">
            <div class="score-box">
                <span id="scoreVal">0</span>
                <span class="multiplier" id="multiVal">LEVEL <span id="level-display">1</span></span>
            </div>
            <div id="boost-container">
                <span style="font-size:0.7rem;font-weight:700">NITRO</span>
                <div class="bar-bg"><div id="boost-bar"></div></div>
            </div>
        </div>
        <div id="xp-container">
            <div class="xp-label">
                <span>XP: <span id="xp-current">0</span>/<span id="xp-needed">1000</span></span>
                <span class="currency">‚Ç°<span id="credits-display">0</span></span>
            </div>
            <div id="xp-bar-bg"><div id="xp-bar"></div></div>
        </div>
        <div id="msg-overlay">PERFECT PASS</div>
        <div id="level-up-overlay">
            <div class="level-up-text">LEVEL UP!</div>
            <div style="font-size:1.5rem;margin-bottom:30px">Level <span id="new-level">2</span></div>
            <button onclick="closeLevelUp()">Continue</button>
        </div>
        
        <!-- Main Menu -->
        <div id="menu" class="menu">
            <h1>MONO<span style="color:#666">DRIVE</span></h1>
            <p class="subtitle">TAP SIDES TO STEER ‚Ä¢ COLLECT ORBS ‚Ä¢ LEVEL UP</p>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">Level</div><div class="stat-value" id="menu-level">1</div></div>
                <div class="stat-card"><div class="stat-label">Credits</div><div class="stat-value currency" id="menu-credits">0</div></div>
                <div class="stat-card"><div class="stat-label">High Score</div><div class="stat-value" id="menu-highscore">0</div></div>
                <div class="stat-card"><div class="stat-label">Achievements</div><div class="stat-value" id="menu-achievements">0/15</div></div>
            </div>
            <div style="display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin-top:20px">
                <button id="startBtn">Drive</button>
                <button class="secondary" onclick="showScreen('challenges')">Challenges</button>
                <button class="secondary" onclick="showScreen('garage')">Garage</button>
                <button class="secondary" onclick="showScreen('achievements')">Achievements</button>
                <button class="secondary" onclick="showScreen('leaderboard')">Leaderboard</button>
            </div>
        </div>
        
        <!-- Game Over -->
        <div id="game-over" class="menu hidden">
            <h1>CRASHED</h1>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">Score</div><div class="stat-value" id="final-score">0</div></div>
                <div class="stat-card"><div class="stat-label">XP Earned</div><div class="stat-value" style="color:#4CAF50" id="final-xp">+0</div></div>
                <div class="stat-card"><div class="stat-label">Credits</div><div class="stat-value currency" id="final-credits">+0</div></div>
                <div class="stat-card"><div class="stat-label">Passes</div><div class="stat-value" id="final-passes">0</div></div>
            </div>
            <div id="new-ach" style="margin:20px 0;display:none"><h3 style="color:var(--gold)">üèÜ NEW ACHIEVEMENTS!</h3><div id="new-ach-list"></div></div>
            <div style="display:flex;gap:10px;margin-top:20px">
                <button id="restartBtn">Retry</button>
                <button class="secondary" onclick="backToMenu()">Menu</button>
            </div>
        </div>
        
        <!-- Garage -->
        <div id="garage" class="menu hidden">
            <h1>GARAGE</h1>
            <p class="subtitle">Credits: <span class="currency" id="garage-credits">0</span></p>
            <div class="upgrade-list" id="upgrade-list"></div>
            <button class="secondary" style="margin-top:20px" onclick="backToMenu()">Back</button>
        </div>
        
        <!-- Achievements -->
        <div id="achievements" class="menu hidden">
            <h1>ACHIEVEMENTS</h1>
            <p class="subtitle"><span id="ach-unlocked">0</span> of <span id="ach-total">15</span> Unlocked</p>
            <div class="achievement-list" id="ach-list"></div>
            <button class="secondary" style="margin-top:20px" onclick="backToMenu()">Back</button>
        </div>
        
        <!-- Leaderboard -->
        <div id="leaderboard" class="menu hidden">
            <h1>LEADERBOARD</h1>
            <div class="leaderboard-list" id="lb-list"></div>
            <button class="secondary" style="margin-top:20px" onclick="backToMenu()">Back</button>
        </div>
        
        <!-- Challenges -->
        <div id="challenges" class="menu hidden">
            <h1>DAILY CHALLENGES</h1>
            <p class="subtitle">Resets: <span id="challenge-timer">23:59:59</span></p>
            <div class="challenge-list" id="challenge-list"></div>
            <button class="secondary" style="margin-top:20px" onclick="backToMenu()">Back</button>
        </div>
    </div>

<script>
// Game Data System with localStorage persistence
const GD={level:1,xp:0,credits:0,highScore:0,totalPasses:0,totalCrashes:0,upgrades:{speed:0,handling:0,nitroEff:0,nitroCap:0,xpBoost:0},achievements:{},dailyChallenges:{},lastChallengeDate:null,leaderboard:[],save(){localStorage.setItem('md_save',JSON.stringify(this))},load(){const s=localStorage.getItem('md_save');if(s)Object.assign(this,JSON.parse(s))},getXPNeeded(lv){return Math.floor(1000*Math.pow(1.15,lv-1))},addXP(amt){const b=Math.floor(amt*(1+this.upgrades.xpBoost*0.1));this.xp+=b;while(this.xp>=this.getXPNeeded(this.level)){this.xp-=this.getXPNeeded(this.level);this.level++;showLevelUp()}updateXPBar();return b},addCredits(amt){this.credits+=amt;updateMenuStats()},unlockAch(id){if(!this.achievements[id]){this.achievements[id]=true;const a=ACH.find(x=>x.id===id);if(a){this.addCredits(a.reward);return a}}return null}};

// Achievements
const ACH=[{id:'first_drive',name:'First Drive',desc:'Complete first run',icon:'üöó',reward:100},{id:'speed_demon',name:'Speed Demon',desc:'Score 50,000',icon:'‚ö°',reward:500},{id:'perfectionist',name:'Perfectionist',desc:'10 perfect passes in one run',icon:'üéØ',reward:300},{id:'nitro_master',name:'Nitro Master',desc:'Use nitro 5 times in run',icon:'üí®',reward:200},{id:'survivor',name:'Survivor',desc:'Score 100,000',icon:'üèÜ',reward:1000},{id:'pass_champion',name:'Pass Champion',desc:'100 perfect passes total',icon:'üåü',reward:750},{id:'level_10',name:'Experienced',desc:'Reach level 10',icon:'üìà',reward:500},{id:'level_25',name:'Expert',desc:'Reach level 25',icon:'üëë',reward:1500},{id:'crasher',name:'Learner',desc:'Crash 50 times',icon:'üí•',reward:100},{id:'rich',name:'Big Spender',desc:'10,000 credits',icon:'üí∞',reward:2000},{id:'fully_upgraded',name:'Fully Tuned',desc:'Max any upgrade',icon:'üîß',reward:1000},{id:'challenge_master',name:'Challenge Master',desc:'Complete all challenges',icon:'‚úÖ',reward:1500},{id:'unstoppable',name:'Unstoppable',desc:'Score 200,000',icon:'üî•',reward:2500},{id:'nitro_crusher',name:'Nitro Crusher',desc:'Destroy 50 cars w/nitro',icon:'üí™',reward:800},{id:'legend',name:'Legend',desc:'Reach level 50',icon:'üå†',reward:5000}];

// Upgrades
const UPG=[{id:'speed',name:'Top Speed',desc:'Increase max speed',maxLv:10,baseCost:200,getBon:lv=>`+${lv*10}% speed`},{id:'handling',name:'Handling',desc:'Better steering',maxLv:10,baseCost:250,getBon:lv=>`+${lv*10}% control`},{id:'nitroEff',name:'Nitro Efficiency',desc:'Nitro lasts longer',maxLv:10,baseCost:300,getBon:lv=>`+${lv*15}% duration`},{id:'nitroCap',name:'Nitro Capacity',desc:'Bigger nitro tank',maxLv:10,baseCost:250,getBon:lv=>`+${lv*20}% capacity`},{id:'xpBoost',name:'XP Multiplier',desc:'Earn more XP',maxLv:10,baseCost:400,getBon:lv=>`+${lv*10}% XP`}];

function genChallenges(){const today=new Date().toDateString();if(GD.lastChallengeDate===today)return;GD.lastChallengeDate=today;GD.dailyChallenges={c1:{target:30000,progress:0,reward:300,done:false},c2:{target:15,progress:0,reward:250,done:false},c3:{target:5,progress:0,reward:200,done:false}};GD.save()}

// Audio Engine
const AE=(()=>{let ctx,master,eOsc,eOsc2,eGain,fNode,running=false,muted=false;function init(){if(ctx)return;ctx=new(window.AudioContext||window.webkitAudioContext)();master=ctx.createGain();master.connect(ctx.destination)}function beep(freq,type,len,gain){if(!ctx||muted)return;const o=ctx.createOscillator(),g=ctx.createGain();o.type=type;o.frequency.value=freq;g.gain.setValueAtTime(gain,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+len);o.connect(g);g.connect(master);o.start();o.stop(ctx.currentTime+len)}return{start:()=>{init();if(running)return;eOsc=ctx.createOscillator();eOsc.type='triangle';eOsc.frequency.value=80;eOsc2=ctx.createOscillator();eOsc2.type='square';eOsc2.frequency.value=40;fNode=ctx.createBiquadFilter();fNode.type='lowpass';fNode.frequency.value=300;eGain=ctx.createGain();eGain.gain.value=0.08;eOsc.connect(fNode);eOsc2.connect(fNode);fNode.connect(eGain);eGain.connect(master);eOsc.start();eOsc2.start();running=true},stop:()=>{if(eOsc){eOsc.stop();eOsc2.stop();running=false}},rev:f=>{if(eOsc&&!muted){eOsc.frequency.setTargetAtTime(80+(f*60),ctx.currentTime,0.08);eOsc2.frequency.setTargetAtTime(40+(f*30),ctx.currentTime,0.08);fNode.frequency.setTargetAtTime(300+(f*400),ctx.currentTime,0.08)}},play:type=>{if(type==='pass')beep(880,'sine',0.2,0.1);if(type==='nitro')beep(1200,'sawtooth',0.3,0.1);if(type==='crash')beep(100,'square',0.5,0.2);if(type==='levelup')beep(1500,'sine',0.5,0.15)}}})();

// Game Engine
const cvs=document.getElementById('gameCanvas'),ctx=cvs.getContext('2d');let w,h,gameActive=false,score=0,speed=7,nitro=0,isNitro=false,frame=0,shake=0;const player={x:0,y:0,targetX:0,history:[]};let entities=[],particles=[],activeTouches=new Set(),runStats={passes:0,nitroUses:0,nitroKills:0};

function resize(){w=cvs.width=cvs.offsetWidth;h=cvs.height=cvs.offsetHeight;player.x=player.targetX=w/2;player.y=h-150}
window.onresize=resize;resize();

const input={left:false,right:false},keys=new Set();
const updateInput=()=>{input.left=activeTouches.has('left')||keys.has('ArrowLeft')||keys.has('KeyA');input.right=activeTouches.has('right')||keys.has('ArrowRight')||keys.has('KeyD')};
window.onkeydown=e=>{keys.add(e.code);updateInput()};
window.onkeyup=e=>{keys.delete(e.code);updateInput()};
cvs.addEventListener('touchstart',e=>{for(let t of e.changedTouches)activeTouches.add(t.clientX<window.innerWidth/2?'left':'right');updateInput()},{passive:false});
cvs.addEventListener('touchend',e=>{activeTouches.clear();for(let t of e.touches)activeTouches.add(t.clientX<window.innerWidth/2?'left':'right');updateInput()});

function spawnPart(x,y,c){for(let i=0;i<12;i++)particles.push({x,y,vx:(Math.random()-0.5)*12,vy:(Math.random()-0.5)*12,l:1,c,size:Math.random()*4+2})}
function showMsg(t){const m=document.getElementById('msg-overlay');m.innerText=t;m.classList.add('pop');setTimeout(()=>m.classList.remove('pop'),800)}

function init(){score=0;speed=7+(GD.upgrades.speed*0.5);nitro=0;entities=[];particles=[];runStats={passes:0,nitroUses:0,nitroKills:0};gameActive=true;document.getElementById('menu').classList.add('hidden');document.getElementById('game-over').classList.add('hidden');AE.start()}

function gameOver(){gameActive=false;shake=15;AE.play('crash');AE.stop();const earnedXP=Math.floor(score/10),earnedCredits=Math.floor(score/100);GD.addXP(earnedXP);GD.addCredits(earnedCredits);GD.totalPasses+=runStats.passes;GD.totalCrashes++;if(score>GD.highScore){GD.highScore=score;addToLB(score)}if(GD.dailyChallenges.c1)GD.dailyChallenges.c1.progress=Math.max(GD.dailyChallenges.c1.progress,score);if(GD.dailyChallenges.c2)GD.dailyChallenges.c2.progress+=runStats.passes;if(GD.dailyChallenges.c3)GD.dailyChallenges.c3.progress+=runStats.nitroUses;const newAch=[];if(!GD.achievements.first_drive){const a=GD.unlockAch('first_drive');if(a)newAch.push(a)}if(score>=50000&&!GD.achievements.speed_demon){const a=GD.unlockAch('speed_demon');if(a)newAch.push(a)}if(score>=100000&&!GD.achievements.survivor){const a=GD.unlockAch('survivor');if(a)newAch.push(a)}if(score>=200000&&!GD.achievements.unstoppable){const a=GD.unlockAch('unstoppable');if(a)newAch.push(a)}if(runStats.passes>=10&&!GD.achievements.perfectionist){const a=GD.unlockAch('perfectionist');if(a)newAch.push(a)}if(runStats.nitroUses>=5&&!GD.achievements.nitro_master){const a=GD.unlockAch('nitro_master');if(a)newAch.push(a)}if(GD.totalPasses>=100&&!GD.achievements.pass_champion){const a=GD.unlockAch('pass_champion');if(a)newAch.push(a)}if(GD.totalCrashes>=50&&!GD.achievements.crasher){const a=GD.unlockAch('crasher');if(a)newAch.push(a)}if(runStats.nitroKills>=50&&!GD.achievements.nitro_crusher){const a=GD.unlockAch('nitro_crusher');if(a)newAch.push(a)}if(GD.level>=10&&!GD.achievements.level_10){const a=GD.unlockAch('level_10');if(a)newAch.push(a)}if(GD.level>=25&&!GD.achievements.level_25){const a=GD.unlockAch('level_25');if(a)newAch.push(a)}if(GD.level>=50&&!GD.achievements.legend){const a=GD.unlockAch('legend');if(a)newAch.push(a)}if(GD.credits>=10000&&!GD.achievements.rich){const a=GD.unlockAch('rich');if(a)newAch.push(a)}for(let k in GD.upgrades){if(GD.upgrades[k]>=10&&!GD.achievements.fully_upgraded){const a=GD.unlockAch('fully_upgraded');if(a)newAch.push(a);break}}const allDone=Object.values(GD.dailyChallenges).every(c=>c.progress>=c.target||c.done);if(allDone&&!GD.achievements.challenge_master){const a=GD.unlockAch('challenge_master');if(a)newAch.push(a)}GD.save();document.getElementById('final-score').innerText=score.toLocaleString();document.getElementById('final-xp').innerText='+'+earnedXP;document.getElementById('final-credits').innerText='+'+earnedCredits;document.getElementById('final-passes').innerText=runStats.passes;if(newAch.length>0){const cont=document.getElementById('new-ach'),list=document.getElementById('new-ach-list');list.innerHTML=newAch.map(a=>`<div style="color:var(--gold);margin:5px 0">${a.icon} ${a.name} (+${a.reward} credits)</div>`).join('');cont.style.display='block'}else{document.getElementById('new-ach').style.display='none'}document.getElementById('game-over').classList.remove('hidden');updateMenuStats()}

function update(){if(!gameActive)return;frame++;const handleBonus=1+(GD.upgrades.handling*0.1),steerSpeed=8*handleBonus;if(input.left)player.targetX-=steerSpeed;if(input.right)player.targetX+=steerSpeed;player.targetX=Math.max(40,Math.min(w-40,player.targetX));player.x+=(player.targetX-player.x)*0.15;if(frame%3===0){player.history.unshift({x:player.x,y:player.y});if(player.history.length>8)player.history.pop()}const nitroEffBonus=1+(GD.upgrades.nitroEff*0.15),nitroDrain=0.5/nitroEffBonus;let curSpeed=isNitro?speed*2.5:speed*(1+score/20000);if(isNitro){nitro-=nitroDrain;if(nitro<=0)isNitro=false;shake=2;if(frame%2===0)particles.push({x:player.x+(Math.random()-0.5)*20,y:player.y+20,vx:0,vy:3,l:1,c:'#fff',size:3})}score+=Math.floor(curSpeed/2);document.getElementById('scoreVal').innerText=score.toLocaleString();document.getElementById('boost-bar').style.width=nitro+"%";AE.rev(curSpeed/15);if(frame%Math.max(20,50-Math.floor(score/2000))===0)entities.push({type:'car',x:Math.random()*(w-80)+40,y:-100,w:30,h:60,passed:false});if(frame%300===0)entities.push({type:'nitro',x:Math.random()*(w-80)+40,y:-100});for(let i=entities.length-1;i>=0;i--){const e=entities[i];e.y+=curSpeed;const dx=Math.abs(player.x-e.x),dy=Math.abs(player.y-e.y);if(e.type==='car'){if(!e.passed&&dy<40&&dx<55&&dx>30){e.passed=true;score+=1000;const nitroCapBonus=1+(GD.upgrades.nitroCap*0.2),maxNitro=100*nitroCapBonus;nitro=Math.min(maxNitro,nitro+15);runStats.passes++;showMsg("PERFECT PASS!");AE.play('pass');spawnPart(e.x,e.y,'#888')}if(dx<28&&dy<55){if(isNitro){spawnPart(e.x,e.y,'#fff');entities.splice(i,1);score+=2000;shake=8;runStats.nitroKills++}else{spawnPart(player.x,player.y,'#fff');gameOver()}}}else if(e.type==='nitro'&&dx<30&&dy<30){const nitroCapBonus=1+(GD.upgrades.nitroCap*0.2),maxNitro=100*nitroCapBonus;nitro=maxNitro;isNitro=true;entities.splice(i,1);runStats.nitroUses++;showMsg("NITRO BOOST!!");AE.play('nitro');spawnPart(e.x,e.y,'#fff')}if(e.y>h+100)entities.splice(i,1)}particles.forEach((p,i)=>{p.x+=p.vx;p.y+=p.vy;p.l-=0.015;p.vy+=0.1;if(p.l<=0)particles.splice(i,1)});if(shake>0)shake*=0.9}

function draw(){const grad=ctx.createLinearGradient(0,0,0,h);grad.addColorStop(0,'#0a0a0a');grad.addColorStop(1,'#1a1a1a');ctx.fillStyle=grad;ctx.fillRect(0,0,w,h);ctx.save();if(shake>1)ctx.translate((Math.random()-0.5)*shake,(Math.random()-0.5)*shake);const rGrad=ctx.createLinearGradient(w/4,0,3*w/4,0);rGrad.addColorStop(0,'#111');rGrad.addColorStop(0.5,'#222');rGrad.addColorStop(1,'#111');ctx.fillStyle=rGrad;ctx.fillRect(w/4,0,w/2,h);ctx.strokeStyle='#333';ctx.lineWidth=3;ctx.shadowBlur=5;ctx.shadowColor='#555';ctx.beginPath();ctx.moveTo(w/4,0);ctx.lineTo(w/4,h);ctx.stroke();ctx.beginPath();ctx.moveTo(3*w/4,0);ctx.lineTo(3*w/4,h);ctx.stroke();ctx.shadowBlur=0;ctx.strokeStyle='#444';ctx.lineWidth=3;ctx.shadowBlur=3;ctx.shadowColor='#666';const offset=(frame*speed*2)%100;for(let y=-100;y<h;y+=100){const lineAlpha=1-(y/h)*0.5;ctx.globalAlpha=lineAlpha;ctx.beginPath();ctx.moveTo(w/3,y+offset);ctx.lineTo(w/3,y+offset+50);ctx.stroke();ctx.beginPath();ctx.moveTo(2*w/3,y+offset);ctx.lineTo(2*w/3,y+offset+50);ctx.stroke()}ctx.globalAlpha=1;ctx.shadowBlur=0;entities.forEach(e=>{if(e.type==='car'){const carGrad=ctx.createLinearGradient(e.x-15,e.y-30,e.x+15,e.y+30);carGrad.addColorStop(0,'#444');carGrad.addColorStop(0.5,'#333');carGrad.addColorStop(1,'#222');ctx.fillStyle=carGrad;ctx.fillRect(e.x-15,e.y-30,30,60);ctx.strokeStyle='#555';ctx.lineWidth=1;ctx.strokeRect(e.x-15,e.y-30,30,60);ctx.fillStyle='#1a1a1a';ctx.fillRect(e.x-12,e.y-25,24,15);ctx.shadowBlur=8;ctx.shadowColor='#f00';ctx.fillStyle='#f00';ctx.fillRect(e.x-12,e.y+25,5,3);ctx.fillRect(e.x+7,e.y+25,5,3);ctx.shadowBlur=0;ctx.fillStyle='#fff';ctx.shadowBlur=5;ctx.shadowColor='#fff';ctx.fillRect(e.x-12,e.y-28,5,2);ctx.fillRect(e.x+7,e.y-28,5,2);ctx.shadowBlur=0}else{const pulse=Math.sin(frame/5)*3;ctx.fillStyle='#fff';ctx.shadowBlur=20+pulse;ctx.shadowColor='#fff';ctx.beginPath();ctx.arc(e.x,e.y,10+pulse,0,Math.PI*2);ctx.fill();ctx.shadowBlur=10;ctx.beginPath();ctx.arc(e.x,e.y,5,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;for(let i=0;i<3;i++){const angle=(frame/10)+(i*Math.PI*2/3),orbitX=e.x+Math.cos(angle)*15,orbitY=e.y+Math.sin(angle)*15;ctx.fillStyle='#aaa';ctx.beginPath();ctx.arc(orbitX,orbitY,2,0,Math.PI*2);ctx.fill()}}});player.history.forEach((h,i)=>{ctx.globalAlpha=(1-i/8)*0.3;const trailGrad=ctx.createLinearGradient(h.x-15,h.y-30,h.x+15,h.y+30);trailGrad.addColorStop(0,'#ccc');trailGrad.addColorStop(1,'#888');ctx.fillStyle=trailGrad;ctx.fillRect(h.x-15,h.y-30,30,60)});ctx.globalAlpha=1;const pGrad=ctx.createLinearGradient(player.x-15,player.y-30,player.x+15,player.y+30);pGrad.addColorStop(0,'#fff');pGrad.addColorStop(0.5,'#ddd');pGrad.addColorStop(1,'#bbb');ctx.fillStyle=pGrad;if(isNitro){ctx.shadowBlur=20;ctx.shadowColor='#fff'}ctx.fillRect(player.x-15,player.y-30,30,60);ctx.shadowBlur=0;ctx.fillStyle='#333';ctx.fillRect(player.x-12,player.y-10,24,15);ctx.fillStyle='#fff';ctx.shadowBlur=10;ctx.shadowColor='#fff';ctx.fillRect(player.x-12,player.y-28,5,3);ctx.fillRect(player.x+7,player.y-28,5,3);ctx.shadowBlur=0;particles.forEach(p=>{ctx.globalAlpha=p.l;ctx.fillStyle=p.c;ctx.shadowBlur=5;ctx.shadowColor=p.c;ctx.fillRect(p.x-p.size/2,p.y-p.size/2,p.size,p.size)});ctx.shadowBlur=0;ctx.restore();update();requestAnimationFrame(draw)}

// UI Functions
function updateMenuStats(){document.getElementById('menu-level').innerText=GD.level;document.getElementById('menu-credits').innerText=GD.credits.toLocaleString();document.getElementById('menu-highscore').innerText=GD.highScore.toLocaleString();const unlocked=Object.keys(GD.achievements).length;document.getElementById('menu-achievements').innerText=`${unlocked}/${ACH.length}`}

function updateXPBar(){const needed=GD.getXPNeeded(GD.level),percent=(GD.xp/needed)*100;document.getElementById('xp-bar').style.width=percent+'%';document.getElementById('level-display').innerText=GD.level;document.getElementById('xp-current').innerText=GD.xp;document.getElementById('xp-needed').innerText=needed;document.getElementById('credits-display').innerText=GD.credits.toLocaleString()}

function showLevelUp(){const overlay=document.getElementById('level-up-overlay');document.getElementById('new-level').innerText=GD.level;overlay.classList.add('show');AE.play('levelup')}

function closeLevelUp(){document.getElementById('level-up-overlay').classList.remove('show')}

function backToMenu(){document.querySelectorAll('.menu').forEach(m=>m.classList.add('hidden'));document.getElementById('menu').classList.remove('hidden');updateMenuStats()}

function showScreen(screen){document.querySelectorAll('.menu').forEach(m=>m.classList.add('hidden'));document.getElementById(screen).classList.remove('hidden');if(screen==='garage')showGarage();if(screen==='achievements')showAchievements();if(screen==='leaderboard')showLeaderboard();if(screen==='challenges')showChallenges()}

function showGarage(){document.getElementById('garage-credits').innerText=GD.credits.toLocaleString();const list=document.getElementById('upgrade-list');list.innerHTML=UPG.map(u=>{const curLv=GD.upgrades[u.id]||0,cost=Math.floor(u.baseCost*Math.pow(1.5,curLv)),canAfford=GD.credits>=cost,isMaxed=curLv>=u.maxLv;return`<div class="upgrade-card"><div class="upgrade-header"><div style="font-weight:700">${u.name}</div><div style="font-size:0.8rem;color:#888">Level ${curLv}/${u.maxLv}</div></div><div style="font-size:0.75rem;color:#aaa;margin-bottom:10px">${u.desc}</div><div class="upgrade-bar"><div class="upgrade-bar-fill" style="width:${(curLv/u.maxLv)*100}%"></div></div><div style="display:flex;justify-content:space-between;align-items:center"><div class="currency">${isMaxed?'MAXED':cost+' credits'}</div><button style="padding:8px 20px;font-size:0.8rem" onclick="buyUpgrade('${u.id}')" ${!canAfford||isMaxed?'disabled':''}>${isMaxed?'Maxed':'Upgrade'}</button></div><div style="font-size:0.75rem;color:#4CAF50;margin-top:5px">${u.getBon(curLv)} ${curLv<u.maxLv?'‚Üí '+u.getBon(curLv+1):''}</div></div>`}).join('')}

function buyUpgrade(id){const u=UPG.find(x=>x.id===id);if(!u)return;const curLv=GD.upgrades[id]||0;if(curLv>=u.maxLv)return;const cost=Math.floor(u.baseCost*Math.pow(1.5,curLv));if(GD.credits<cost)return;GD.credits-=cost;GD.upgrades[id]=curLv+1;GD.save();showGarage()}

function showAchievements(){const unlocked=Object.keys(GD.achievements).length;document.getElementById('ach-unlocked').innerText=unlocked;document.getElementById('ach-total').innerText=ACH.length;const list=document.getElementById('ach-list');list.innerHTML=ACH.map(a=>{const isUnlocked=GD.achievements[a.id];return`<div class="achievement ${isUnlocked?'unlocked':''}"><div class="achievement-icon">${a.icon}</div><div class="achievement-info"><div class="achievement-name">${a.name}</div><div class="achievement-desc">${a.desc}</div><div style="font-size:0.7rem;color:#4CAF50;margin-top:2px">${isUnlocked?'Unlocked!':'Reward: '+a.reward+' credits'}</div></div></div>`}).join('')}

function showLeaderboard(){const list=document.getElementById('lb-list');if(GD.leaderboard.length===0){list.innerHTML='<div style="text-align:center;padding:40px;color:#666">No scores yet. Start playing!</div>'}else{list.innerHTML=GD.leaderboard.map((e,i)=>`<div class="leaderboard-entry ${i===0?'rank1':''}"><div style="font-size:1.2rem;font-weight:800;width:40px">#${i+1}</div><div style="flex:1;font-weight:600">Run ${e.id}</div><div class="currency">${e.score.toLocaleString()}</div></div>`).join('')}}

function addToLB(score){GD.leaderboard.push({id:GD.leaderboard.length+1,score,date:new Date().toISOString()});GD.leaderboard.sort((a,b)=>b.score-a.score);GD.leaderboard=GD.leaderboard.slice(0,10);GD.save()}

function showChallenges(){genChallenges();updateChallengeTimer();const list=document.getElementById('challenge-list');const ch=[{name:'High Score',desc:'Reach 30,000',...GD.dailyChallenges.c1},{name:'Perfect Driver',desc:'15 perfect passes',...GD.dailyChallenges.c2},{name:'Nitro Enthusiast',desc:'Use nitro 5 times',...GD.dailyChallenges.c3}];list.innerHTML=ch.map((c,i)=>{const progress=Math.min(c.progress,c.target),percent=(progress/c.target)*100,isComplete=progress>=c.target;if(isComplete&&!c.done){GD.dailyChallenges[`c${i+1}`].done=true;GD.addCredits(c.reward);GD.save()}return`<div class="challenge-card ${isComplete?'completed':''}"><div class="challenge-header"><div class="challenge-name">${c.name}</div><div class="challenge-reward">${isComplete?'‚úì Completed':'+'+c.reward+' credits'}</div></div><div class="challenge-progress">${c.desc}: ${progress.toLocaleString()}/${c.target.toLocaleString()}</div><div class="challenge-bar"><div class="challenge-bar-fill" style="width:${percent}%"></div></div></div>`}).join('')}

function updateChallengeTimer(){const now=new Date(),tomorrow=new Date(now);tomorrow.setDate(tomorrow.getDate()+1);tomorrow.setHours(0,0,0,0);const diff=tomorrow-now,hours=Math.floor(diff/3600000),minutes=Math.floor((diff%3600000)/60000),seconds=Math.floor((diff%60000)/1000);const timer=document.getElementById('challenge-timer');if(timer)timer.innerText=`${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`}

setInterval(updateChallengeTimer,1000);

// Init
GD.load();genChallenges();updateMenuStats();updateXPBar();
document.getElementById('startBtn').onclick=init;
document.getElementById('restartBtn').onclick=init;
draw();
</script>
</body>
</html>
